set power_enable_analysis TRUE

if {$power_enable_timing_analysis == false} {set_app_var power_enable_timing_analysis true} 

# set power_analysis_mode averaged
set power_analysis_mode time_based


set file_handle [open "../../sim/variables.txt" r]
set K [gets $file_handle]
set N [gets $file_handle]
set LUT_SIZE [gets $file_handle]
set WIDTH_COEFFICIENT [gets $file_handle]
set NUM_ADD_CLK [gets $file_handle]
set NUM_ADDER_STAGES [gets $file_handle]

set NUM_INPUTS_S3 [gets $file_handle]
set NUM_INPUTS_S2 [gets $file_handle]
set NUM_INPUTS_S1 [gets $file_handle]
set NUM_S3_ADDERS [gets $file_handle]
set NUM_S2_ADDERS [gets $file_handle]
set NUM_S1_ADDERS [gets $file_handle]

set CLK_PERIOD [gets $file_handle]
set CLK_PERIOD_HALF [gets $file_handle]

set N_MAX [gets $file_handle]
set K_MAX [gets $file_handle]

close $file_handle


set VOLTAGE 1.10
set CORNER tt
set TEMP 25C
set THRESHOLD LR
set TRACE_HEIGHT 12
set TYPE_SHORT SC

if { [info exists ::env(VOLTAGE)] } {
  set VOLTAGE $::env(VOLTAGE)
  # set VOLTAGE [string replace ${VOLTAGE} 1 1 .]
}
if { [info exists ::env(CORNER)] } {
  set CORNER $::env(CORNER)
}
if { [info exists ::env(TEMP)] } {
  set TEMP $::env(TEMP)
}
if { [info exists ::env(THRESHOLD)] } {
  set THRESHOLD $::env(THRESHOLD)
}
if { [info exists ::env(TRACE_HEIGHT)] } {
  set TRACE_HEIGHT $::env(TRACE_HEIGHT)
}
if { [info exists ::env(TYPE_SHORT)] } {
  set TYPE_SHORT $::env(TYPE_SHORT)
}


set TARGET_LIB C28SOI_${TYPE_SHORT}_${TRACE_HEIGHT}_CORE_${THRESHOLD}_${CORNER}28_${VOLTAGE}V_${TEMP}
set TARGET_LIB_CLK C28SOI_${TYPE_SHORT}_${TRACE_HEIGHT}_CLK_${THRESHOLD}_${CORNER}28_${VOLTAGE}V_${TEMP}
set TARGET_LIB_PR C28SOI_${TYPE_SHORT}_${TRACE_HEIGHT}_PR_${THRESHOLD}_${CORNER}28_${VOLTAGE}V_${TEMP}

set LIBRARY_SEARCH_PATH "/eda/kits/stm/28nm_fdsoi_v1.5a/C28SOI_${TYPE_SHORT}_${TRACE_HEIGHT}_CORE_${THRESHOLD}/5.1-05.81/libs/"
set LIBRARY_SEARCH_PATH_CLK "/eda/kits/stm/28nm_fdsoi_v1.5a/C28SOI_${TYPE_SHORT}_${TRACE_HEIGHT}_CLK_${THRESHOLD}/5.1-06.81/libs/"
set LIBRARY_SEARCH_PATH_PR "/eda/kits/stm/28nm_fdsoi_v1.5a/C28SOI_${TYPE_SHORT}_${TRACE_HEIGHT}_PR_${THRESHOLD}/5.3.a-00.80/libs/"



#####################################################################
#       link design
#####################################################################

set search_path "../syn/DC/ \
  ${LIBRARY_SEARCH_PATH} \
  ${LIBRARY_SEARCH_PATH_CLK} \
  ${LIBRARY_SEARCH_PATH_PR} ."

set link_library " * ${TARGET_LIB}.db \
* ${TARGET_LIB_CLK}.db \
* ${TARGET_LIB_PR}.db"

#####################################################################
#       load design name from namemap file
#####################################################################
set VERSION 1
if { [info exists ::env(VERSION)] } {
  set VERSION $::env(VERSION)
}


if {$VERSION eq "acc_mcKvar"} {
  set result_dir_name "results_N${N}_K_MAX${K_MAX}"
} elseif {$VERSION eq "acc_mcNvar"} {
  set result_dir_name "results_N_MAX${N_MAX}_K${K}"
} elseif {$VERSION eq "acc_mc_paramKN_downsample"} {
  set result_dir_name "results_N_MAX${N_MAX}_K_MAX${K_MAX}"
} else {
  set result_dir_name "results_N${N}_K${K}"
}
puts "result_dir_name = $result_dir_name"
set f [open "../../syn/DC/${result_dir_name}/picorv32_top.mapped.SAIF.namemap" r]
set content [read $f]
close $f
if {[regexp {# design (\S+)} $content match design_name]} {
    puts "Design: $design_name"
} else {
    puts "Design not found."
}

read_verilog ../../syn/DC/${result_dir_name}/picorv32_top.mapped.v
current_design $design_name
link


#####################################################################
#       set transition time / annotate parasitics
#####################################################################

read_sdc ../../syn/DC/${result_dir_name}/picorv32_top.mapped.sdc -version "2.1" -echo
read_parasitics ../../syn/DC/${result_dir_name}/picorv32_top.mapped.spef


report_annotated_parasitics > annotated_parasitics.log


#####################################################################
#       check/update/report timing 
#####################################################################
check_timing
update_timing
report_timing > timing_report.log

#####################################################################
#       read switching activity file
#####################################################################

set script_path [file normalize [info script]]
set script_dir [file dirname $script_path]
set design_name_path [string map {"/home/anbjors/pro/" "" "/pwr" ""} $script_dir]
puts "vcd file name = $design_name_path.vcd"

read_vcd /sim/anbjors/accelerator/${design_name_path}.vcd -strip_path "tb_picorv32/chip" -format systemverilog

# read_saif /sim/anbjors/coreTest-dc.saif

report_switching_activity > switching_activity.log


#####################################################################
#       check/update/report power 
#####################################################################
check_power
# set_power_analysis_options -waveform_format fsdb -waveform_output /sim/anbjors/power_time_based
update_power
report_power > power_report.log

quit
